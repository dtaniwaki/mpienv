#!/bin/bash

export MPIENV_ROOT="$(cd "$(dirname "${BASH_SOURCE:-$0}")"; pwd)"

if [ ! -f $MPIENV_ROOT/shims ]; then
    G=$MPIENV_ROOT/version_global
    if [ -f $G ]; then
        ln -s $(cat $G) $MPIENV_ROOT/shims
    fi
fi

export PATH=$MPIENV_ROOT/shims/bin:${PATH:-}
export LD_LIBRARY_PATH=$MPIENV_ROOT/shims/lib:$MPIENV_ROOT/shims/lib64:${LD_LIBRARY_PATH:-}

function usage() {
    echo "Usage: mpienv [command] [options...]"
}

function mpienv() {
    if [ "0" = "${#*}" ]; then
        usage
        return -1
    fi

    declare -r root=$MPIENV_ROOT
    declare -r command="$1"
    shift

    case "$command" in
        "use" )
            {
                python $root/mpienv_use.py $*
                if [ ! -n "$ZSH_VERSION" ]; then
                    rehash
                fi
            }
            ;;
        "add" )
            {
                python $root/mpienv_add.py $*
            }
            ;;
        "rm" )
            {
                python $root/mpienv_rm.py $*
            }
            ;;
        "rename" )
            {
                python $root/mpienv_rename.py $*
            }
            ;;
        "list" )
            {
                python $root/mpienv_list.py $*
            }
            ;;
        "info" )
            {
                python $root/mpienv_info.py $*
            }
            ;;
        "autodiscover" )
            {
                python $root/mpienv_autodiscover.py $*
            }
            ;;
        * )
            echo "mpienv [ERROR]: Unknown command '$command'"
            ;;
    esac
}
